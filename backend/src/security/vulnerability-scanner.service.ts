import { Injectable, Logger, OnModuleInit } from '@nestjs/common';
import { SecurityService } from './security.service';
import axios from 'axios';

@Injectable()
export class VulnerabilityScannerService implements OnModuleInit {
    private readonly logger = new Logger('VulnerabilityScanner');
    private readonly baseUrl = `http://localhost:${process.env.PORT || 3005}`;

    constructor(private securityService: SecurityService) { }

    onModuleInit() {
        // Run a full scan every 12 hours
        setInterval(() => this.runFullScan(), 12 * 60 * 60 * 1000);
    }

    async runFullScan() {
        this.logger.log('Starting automated vulnerability scan...');

        await this.testRbacBypass();
        await this.testIdEnumeration();
        await this.testPublicExposure();

        this.logger.log('Vulnerability scan completed.');
    }

    private async testRbacBypass() {
        this.logger.log('Testing RBAC bypass (Customer attempting Admin endpoint)...');
        try {
            // simulate an unauthenticated or low-privilege request to an admin endpoint
            const response = await axios.get(`${this.baseUrl}/admin/users`, {
                validateStatus: () => true,
            });

            if (response.status === 200) {
                await this.securityService.logEvent({
                    level: 'CRITICAL',
                    eventType: 'VULNERABILITY_FOUND',
                    description: 'RBAC Bypass detected: /admin/users is accessible without proper authorization!',
                });
            }
        } catch (error) {
            this.logger.error('RBAC bypass test failed', error);
        }
    }

    private async testIdEnumeration() {
        this.logger.log('Testing ID Enumeration pattern detection...');
        try {
            // Simulate sequential ID hitting
            for (let i = 1; i <= 5; i++) {
                await axios.get(`${this.baseUrl}/products/${i}`, { validateStatus: () => true });
            }
        } catch (error) { }
    }

    private async testPublicExposure() {
        this.logger.log('Testing for public .env or .git exposure...');
        const sensitiveFiles = ['.env', '.git/config', 'package.json'];
        for (const file of sensitiveFiles) {
            try {
                const response = await axios.get(`${this.baseUrl}/${file}`, { validateStatus: () => true });
                if (response.status === 200) {
                    await this.securityService.logEvent({
                        level: 'CRITICAL',
                        eventType: 'VULNERABILITY_FOUND',
                        description: `Sensitive file exposure detected: ${file} is publicly accessible!`,
                    });
                }
            } catch (error) { }
        }
    }
}
